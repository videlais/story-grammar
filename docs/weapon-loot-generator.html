<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weapon Loot Table Generator - Story Grammar Example</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e, #1a252f);
            color: #ecf0f1;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(236, 240, 241, 0.2);
        }
        
        h1 {
            color: #f39c12;
            font-size: 3em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
        }
        
        .subtitle {
            font-style: italic;
            color: #bdc3c7;
            margin-top: 15px;
            font-size: 1.2em;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            font-family: inherit;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
        }
        
        .loot-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .weapon-card {
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .weapon-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .weapon-card.common::before {
            background: #95a5a6; /* White/Gray for Common */
        }
        
        .weapon-card.magic::before {
            background: #3498db; /* Blue for Magic */
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .weapon-card.rare::before {
            background: #f1c40f; /* Yellow for Rare */
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
        }
        
        .weapon-card.legendary::before {
            background: #e67e22; /* Orange for Legendary */
            box-shadow: 0 0 20px rgba(230, 126, 34, 0.7);
        }
        
        .weapon-card.unique::before {
            background: linear-gradient(90deg, #f39c12, #d4af37, #f39c12); /* Gold/Tan for Unique */
            box-shadow: 0 0 25px rgba(243, 156, 18, 0.8);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .weapon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .rarity-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .rarity-badge.common {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
            border: 1px solid #95a5a6;
        }
        
        .rarity-badge.magic {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid #3498db;
        }
        
        .rarity-badge.rare {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
            border: 1px solid #f1c40f;
        }
        
        .rarity-badge.legendary {
            background: rgba(230, 126, 34, 0.2);
            color: #e67e22;
            border: 1px solid #e67e22;
        }
        
        .rarity-badge.unique {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        
        .weapon-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ecf0f1;
        }
        
        .weapon-type {
            color: #bdc3c7;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .weapon-stats {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .stat-label {
            color: #95a5a6;
        }
        
        .stat-value {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .stats-panel {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(236, 240, 241, 0.2);
        }
        
        .stats-panel h3 {
            color: #f39c12;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .rarity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .rarity-stat {
            background: rgba(44, 62, 80, 0.6);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid;
        }
        
        .rarity-stat.common {
            border-left-color: #95a5a6;
        }
        
        .rarity-stat.magic {
            border-left-color: #3498db;
        }
        
        .rarity-stat.rare {
            border-left-color: #f1c40f;
        }
        
        .rarity-stat.legendary {
            border-left-color: #e67e22;
        }
        
        .rarity-stat.unique {
            border-left-color: #f39c12;
        }
        
        .rarity-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .rarity-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #2ecc71;
        }
        
        .rarity-percentage {
            font-size: 0.9em;
            color: #bdc3c7;
        }
        
        .loading {
            text-align: center;
            font-style: italic;
            color: #f39c12;
            padding: 40px;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .loot-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 250px;
            }
            
            h1 {
                font-size: 2.2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öîÔ∏è Weapon Loot Table Generator ‚öîÔ∏è</h1>
        <p class="subtitle">Powered by Story Grammar Weighted Rules - RPG Item Generation</p>
        <p>Generate random weapons with authentic RPG rarity distribution and dynamic stats</p>
    </div>

    <div class="controls">
        <button class="btn" onclick="generateSingleWeapon()" disabled>üó°Ô∏è Generate Single Weapon</button>
        <button class="btn secondary" onclick="generateLootDrop()" disabled>üì¶ Generate Loot Drop (10 items)</button>
        <button class="btn secondary" onclick="generateMassiveDrop()" disabled>üí∞ Generate Massive Drop (50 items)</button>
        <button class="btn" onclick="clearLoot()">üßπ Clear All</button>
    </div>

    <div id="loading" class="loading" style="display: none;">
        Rolling for loot... üé≤
    </div>

    <div id="stats" class="stats-panel" style="display: none;">
        <h3>üìä Loot Distribution Statistics</h3>
        <div class="rarity-stats">
            <div class="rarity-stat common">
                <div class="rarity-name">Common</div>
                <div class="rarity-count" id="common-count">0</div>
                <div class="rarity-percentage">38.06% expected</div>
            </div>
            <div class="rarity-stat magic">
                <div class="rarity-name">Magic</div>
                <div class="rarity-count" id="magic-count">0</div>
                <div class="rarity-percentage">50.00% expected</div>
            </div>
            <div class="rarity-stat rare">
                <div class="rarity-name">Rare</div>
                <div class="rarity-count" id="rare-count">0</div>
                <div class="rarity-percentage">10.44% expected</div>
            </div>
            <div class="rarity-stat unique">
                <div class="rarity-name">Unique</div>
                <div class="rarity-count" id="unique-count">0</div>
                <div class="rarity-percentage">1.5% expected</div>
            </div>
        </div>
    </div>

    <div id="loot" class="loot-container"></div>

    <!-- Load Story Grammar from local copy -->
    <script src="./dist/story-grammar.bundle.js"></script>
    
    <script>
        // Global variables
        let parser;
        let weaponStats = {
            common: 0,
            magic: 0,
            rare: 0,
            unique: 0
        };

        // Wait for Story Grammar to load
        function waitForStoryGrammar() {
            return new Promise((resolve, reject) => {
                const maxAttempts = 50;
                let attempts = 0;
                
                const checkLoaded = () => {
                    attempts++;
                    if (typeof StoryGrammar !== 'undefined' && StoryGrammar.Parser) {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Story Grammar library failed to load'));
                    } else {
                        setTimeout(checkLoaded, 100);
                    }
                };
                
                checkLoaded();
            });
        }

        // Initialize the Story Grammar parser
        async function initializeParser() {
            try {
                console.log('Waiting for Story Grammar to load...');
                await waitForStoryGrammar();
                console.log('Story Grammar loaded successfully!');

                parser = new StoryGrammar.Parser();
                
                // Load English modifiers
                try {
                    if (StoryGrammar.EnglishArticleModifier) {
                        parser.loadModifier(StoryGrammar.EnglishArticleModifier);
                    }
                    if (StoryGrammar.EnglishPluralizationModifier) {
                        parser.loadModifier(StoryGrammar.EnglishPluralizationModifier);
                    }
                } catch (modifierError) {
                    console.error('Error loading modifiers:', modifierError);
                }

                setupWeaponGrammar();
                
                // Enable buttons
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => btn.disabled = false);
                
            } catch (error) {
                console.error('Error initializing Story Grammar:', error);
                alert('Error loading Story Grammar. Please refresh the page.');
            }
        }
        
        // Define the weapon loot grammar
        function setupWeaponGrammar() {
            // Weapon rarity with specified drop rates (adjusted to sum to 100%)
            // Note: Legendary was not in the original rates, so distributing remaining 0% as part of rare/unique
            parser.addWeightedRule('weapon_rarity', 
                ['common', 'magic', 'rare', 'unique'], 
                [0.3806, 0.5000, 0.1044, 0.015] // Adjusted to sum exactly to 1.0 (100%)
            );

            // Base weapon types
            parser.addRule('weapon_types', [
                'Axe', 'Bow', 'Crossbow', 'Dagger', 'Hammer', 'Javelin', 'Mace', 'Polearm',
                'Scepter', 'Spear', 'Staff', 'Sword', 'Throwing Weapon', 'Two-Handed Axe',
                'Two-Handed Mace', 'Two-Handed Sword', 'Wand'
            ]);

            // Throwing weapon subtypes
            parser.addRule('throwing_subtypes', [
                'Throwing Knife', 'Throwing Axe', 'Explosive Potion', 'Poison Vial', 'Fire Bomb'
            ]);

            // Material prefixes by rarity
            parser.addRule('common_materials', [
                'Iron', 'Steel', 'Bronze', 'Wooden', 'Leather-wrapped', 'Simple'
            ]);

            parser.addRule('magic_materials', [
                'Enchanted', 'Magical', 'Blessed', 'Arcane', 'Mystical', 'Elemental'
            ]);

            parser.addRule('rare_materials', [
                'Masterwork', 'Runic', 'Crystalline', 'Dragonforged', 'Ancient', 'Celestial'
            ]);

            parser.addRule('unique_materials', [
                'Legendary', 'Artifact', 'Divine', 'Primordial', 'Ethereal', 'Worldbreaker'
            ]);

            // Suffixes by rarity
            parser.addRule('common_suffixes', [
                '', '', '', 'of Sharpness', 'of Durability', 'of Balance'
            ]);

            parser.addRule('magic_suffixes', [
                'of Power', 'of the Warrior', 'of Striking', 'of Protection', 'of Speed', 'of Might'
            ]);

            parser.addRule('rare_suffixes', [
                'of the Champion', 'of Dragon Slaying', 'of the Elements', 'of Devastation', 'of the Masters', 'of Legends'
            ]);

            parser.addRule('unique_suffixes', [
                'of the Gods', 'of World Breaking', 'of Infinite Power', 'of the Void', 'of Creation', 'of Destiny'
            ]);

            // Stat ranges by rarity using range rules
            parser.addRangeRule('common_damage', { min: 8, max: 15, type: 'integer' });
            parser.addRangeRule('magic_damage', { min: 15, max: 25, type: 'integer' });
            parser.addRangeRule('rare_damage', { min: 25, max: 40, type: 'integer' });
            parser.addRangeRule('unique_damage', { min: 40, max: 75, type: 'integer' });

            parser.addRangeRule('common_durability', { min: 50, max: 80, type: 'integer' });
            parser.addRangeRule('magic_durability', { min: 80, max: 120, type: 'integer' });
            parser.addRangeRule('rare_durability', { min: 120, max: 180, type: 'integer' });
            parser.addRangeRule('unique_durability', { min: 180, max: 300, type: 'integer' });

            // Special effects by rarity
            parser.addRule('magic_effects', [
                '+5 Fire Damage', '+3 Ice Damage', '+10% Attack Speed', '+15% Accuracy', 'Glows in Dark'
            ]);

            parser.addRule('rare_effects', [
                '+15% Critical Hit Chance', 'Lifesteal: 8%', '+25 Elemental Resistance', 'Chain Lightning on Hit', 'Phase Through Armor'
            ]);

            parser.addRule('unique_effects', [
                'Time Slow on Critical Hit', 'Summons Spectral Warriors', 'Ignores All Armor', 'Resurrects Fallen Allies', 'Controls Weather'
            ]);
        }

        // Generate a single weapon with full stats
        function generateWeapon() {
            if (!parser) {
                console.error('Parser not initialized yet');
                return null;
            }

            try {
                const rarity = parser.parse('%weapon_rarity%');
                let weaponType = parser.parse('%weapon_types%');
                
                // Handle throwing weapons specially
                if (weaponType === 'Throwing Weapon') {
                    weaponType = parser.parse('%throwing_subtypes%');
                }

                let material, suffix, damage, durability, specialEffect = '';

                // Generate stats based on rarity
                switch(rarity) {
                    case 'common':
                        material = parser.parse('%common_materials%');
                        suffix = parser.parse('%common_suffixes%');
                        damage = parser.parse('%common_damage%');
                        durability = parser.parse('%common_durability%');
                        break;
                    case 'magic':
                        material = parser.parse('%magic_materials%');
                        suffix = parser.parse('%magic_suffixes%');
                        damage = parser.parse('%magic_damage%');
                        durability = parser.parse('%magic_durability%');
                        specialEffect = parser.parse('%magic_effects%');
                        break;
                    case 'rare':
                        material = parser.parse('%rare_materials%');
                        suffix = parser.parse('%rare_suffixes%');
                        damage = parser.parse('%rare_damage%');
                        durability = parser.parse('%rare_durability%');
                        specialEffect = parser.parse('%rare_effects%');
                        break;
                    case 'unique':
                        material = parser.parse('%unique_materials%');
                        suffix = parser.parse('%unique_suffixes%');
                        damage = parser.parse('%unique_damage%');
                        durability = parser.parse('%unique_durability%');
                        specialEffect = parser.parse('%unique_effects%');
                        break;
                }

                // Construct weapon name
                let weaponName = `${material} ${weaponType}`;
                if (suffix && suffix.trim()) {
                    weaponName += ` ${suffix}`;
                }

                return {
                    name: weaponName,
                    type: weaponType,
                    rarity: rarity,
                    damage: damage,
                    durability: durability,
                    specialEffect: specialEffect
                };

            } catch (error) {
                console.error('Error generating weapon:', error);
                return null;
            }
        }

        // Display a weapon card
        function displayWeapon(weapon) {
            if (!weapon) return;

            const container = document.getElementById('loot');
            
            const weaponDiv = document.createElement('div');
            weaponDiv.className = `weapon-card ${weapon.rarity}`;
            
            let effectsHtml = '';
            if (weapon.specialEffect) {
                effectsHtml = `
                    <div class="stat-line">
                        <span class="stat-label">Special Effect:</span>
                        <span class="stat-value">${weapon.specialEffect}</span>
                    </div>
                `;
            }
            
            weaponDiv.innerHTML = `
                <div class="rarity-badge ${weapon.rarity}">${weapon.rarity}</div>
                <div class="weapon-name">${weapon.name}</div>
                <div class="weapon-type">${weapon.type}</div>
                <div class="weapon-stats">
                    <div class="stat-line">
                        <span class="stat-label">Damage:</span>
                        <span class="stat-value">${weapon.damage}</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-label">Durability:</span>
                        <span class="stat-value">${weapon.durability}</span>
                    </div>
                    ${effectsHtml}
                </div>
            `;
            
            container.appendChild(weaponDiv);
            
            // Update statistics
            weaponStats[weapon.rarity]++;
            updateStatistics();
        }

        // Generate single weapon
        function generateSingleWeapon() {
            const weapon = generateWeapon();
            if (weapon) {
                displayWeapon(weapon);
                document.getElementById('stats').style.display = 'block';
            }
        }

        // Generate loot drop (10 items)
        function generateLootDrop() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            setTimeout(() => {
                for (let i = 0; i < 10; i++) {
                    const weapon = generateWeapon();
                    if (weapon) {
                        displayWeapon(weapon);
                    }
                }
                loading.style.display = 'none';
                document.getElementById('stats').style.display = 'block';
            }, 500);
        }

        // Generate massive drop (50 items)
        function generateMassiveDrop() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            setTimeout(() => {
                for (let i = 0; i < 50; i++) {
                    const weapon = generateWeapon();
                    if (weapon) {
                        displayWeapon(weapon);
                    }
                }
                loading.style.display = 'none';
                document.getElementById('stats').style.display = 'block';
            }, 1000);
        }

        // Update statistics display
        function updateStatistics() {
            document.getElementById('common-count').textContent = weaponStats.common;
            document.getElementById('magic-count').textContent = weaponStats.magic;
            document.getElementById('rare-count').textContent = weaponStats.rare;
            document.getElementById('unique-count').textContent = weaponStats.unique;
        }

        // Clear all loot
        function clearLoot() {
            document.getElementById('loot').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
            weaponStats = {
                common: 0,
                magic: 0,
                rare: 0,
                unique: 0
            };
            updateStatistics();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Disable buttons initially
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Loading weapon database...';
            
            // Initialize parser
            initializeParser().then(() => {
                document.getElementById('loading').style.display = 'none';
                console.log('Weapon Loot Table Generator ready!');
            }).catch(error => {
                document.getElementById('loading').textContent = 'Error loading. Please refresh the page.';
                document.getElementById('loading').style.color = 'red';
                console.error('Failed to initialize:', error);
            });
        });
    </script>
</body>
</html>